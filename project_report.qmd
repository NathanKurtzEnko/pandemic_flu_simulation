---
title: "Pandemic Flu Simulation"
author: "Nathan Kurtz-Enko"
format: pdf
toc: true
echo: false
eval: false
warning: false
message: false
bibliography: references.bib
---

# Abstract

-   Problem

-   Previous approaches

-   Novelty

-   Key findings

# Background

Understanding the behavior of the spread of infectious disease, like flu pandemics, is critical for advising policy making with respect to public health and wellness. For example, studying the behavior of virus transmission and recovery rates allows health professionals and policymakes to define the quantity of antiviral agents that should be readily available, regions and demographics that should be prioritized for vaccination, and other strategies intended to prevent a pandemic. Furthermore, being able to communicate the results of an infectious disease outbreak model/simulation is very important as this will facilitate adoption of containment measures.

Many researchers studying the spread of infectious disease explicitly cite the 1918 influenza outbreak [@berkessel2021social; @germann2006mitigation; @johnson2002spanishflu] as a motivating factor for their work. In the case of @johnson2002spanishflu and @patterson1991geography, the objective was to look back through previous records and data to verify morbitity of the 1918 pandemic. The authors made the observation that each time the statistics are reviewed, the total deaths from the pandemic seem to increase. In the 1920s, the record was approximately 21.5 million deaths; in 1991, @patterson1991geography updated the estimate to 24.7-39.3 million; most recently, @johnson2002spanishflu estimated the death toll is on the order of 50 million. However, @johnson2002spanishflu does not make this claim definitively. Instead, he allows for speculation on different records in future estimates because there are many places affected by the 1918 influenza for which we do not have any data.

Clearly, the capacity for large-scale damage from infectious disease outbreaks is a very real threat. Hence, understanding how these things spread and the impact that different mitigation strategies have on the rate of spread and severity of illness is critical.

## Literature Review

Infectious disease epidemic models have been the subject of study since the 1980s. It was Russian scientists that first began to implement models for estimating spread patterns of influenza and other viruses [@longini1986global]. Much of that work is relatively inaccessible due to the fact that it is written in Russian. Nonetheless, eventually their work made its way into academia across the globe.

There are deterministic and stochastic approaches to modeling pandemic flu. However, early models were deterministic, and they described the movement of viruses using differential equations and partitioned populations into a number of subgroups. These are referred to as SIR (susceptible-infected-recovered), SEIR (susceptible-exposed-infected-recovered), and other derivatives.

Initial reactions to these determinsitic models were skeptical for a few reasons. First, geographic regions being studied were relatively isolated, hence the ability to apply these models for global study was uncertain [@longini1986global]. Furthermore, for the time, these approaches were computationally expensive. @longini1986global noted that over 90% of time was dedicated to running the algorithms themselves. However, this is less of an issue now because high-performance computing is readily available.

While relatively old, these models, and similar derivatives, still have applications today. @valle2012behavior used a deterministic model to show that an individual's behavior will likely change in response to an outbreak; some individuals will adopt new behavior to protect themselves, thereby influencing the probability of transmission per contact. 

More recently, stochastic models have become prevelant because they are able to capture more complex spreading patterns. @colizza2007global, @cooper2006delaying, @ferguson2005containment, @germann2006mitigation, @samsuzzoha2013parameter, and @tan2021stochastic all used some stochastic process to model the spread of influenza or other infectious disease, and analyze different mitigation strategies. @colizza2007global found that a large-scale application of prophylaxis antiviral agents could successfully contain a pandemic H5N1 influenza given a viral reproduction ratio of 1.9 or lower. @cooper2006delaying found that significant air travel restrictions could delay the spread of pandemic influenza, but not contain an epidemic altogether. The findings of @germann2006mitigation determined that rapid and preferential vaccination of children could contain an outbreak when the reproduction ratio of influenza is at or below 1.9.

Others have explored the relationship between geographic variables (e.g., altitude and solar radiation) and incidence rates for COVID-19, as well as severity of illness [@arias2021altitude; @stephens2021altitude]. @arias2021altitude concluded that above 1000 meters above sea level, incidence rates and severity for COVID-19 decline. Through analysis of public geographic and COVID-19 data, @stephens2021altitude determined that for increases of 495 meters in elevation above LA county, and for areas of equivalent population density, infection rates were 12.82%, 12.01%, and 11.72%. However, mortality rates were not statistically significantly different between high and low elevation areas. @stephens2021altitude notes that other environmental variables such as increased solar radiation, larger swings of high/low temperatures throughout the day, and long-term exposure to altitude hypoxia could explain these observed differences.

Since influenza and similar viruses spread via aerosols, @sagripanti2007solar proposed solar radiation as a contributing factor to the seasonality of influenza. Specifically, the authors calculated the expected inactivation of influenza by UV radiation in several cities and different times of the year. They estimated that a full day of sunlight exposure will reduce influenza by 99% in regions at a similar latitude to Mexico City, and by 90% in regions at a similar latitude to Miami. However, @weber2008note note that the impact on survivability of influenza by humidity and temperature are as significant as solar radiation. Furthermore, it is unlikely that outdoor transmission is a significant mechanism for the spread of influenza because it is so sensitive to wide range of environmental variables.

Regardless, it is clear that higher altitude, higher humidity/temperature, and higher solar radiation could theoretically influence the spread of pandemic influenza. The purpose of this paper will be to simulate pandemic flu spread and identify critical thresholds for these covariates in order to minimize the risk of a severe outbreak.

## Modeling

As previously mentioned, there are two very general approaches to simulating pandemic virus spread. We will be discussing the SIR model [@debarre_sir; @wb_deterministic] because it is relatively simple, and establishes a foundation for considering other approaches.

The SIR model categorizes a population into three groups: susceptible, infected, and recovered. The rate of change of each of these groups is defined using differential equations, and we can account for mortality and birth rates in their definitions as well.

$$
\begin{aligned}
\frac{dS}{dt} =& \delta - \frac{\beta \times S \times I}{N} - \mu \times S \\
\frac{dI}{dt} =& \frac{\beta \times S \times I}{N} - (\gamma + \mu) \times I \\
\frac{dR}{dt} =& \gamma \times I - \mu \times R
\end{aligned}
$$

Here, $S$, $I$, $R$ stand for the susceptible, infected, and recovered groups respectively. The population is denoted by $N$, and the rates of transmission, recovery, mortality, and birth are denoted by $\beta$, $\gamma$, $\mu$, and $\delta$.

The outbreak status is described by the reproduction ratio, which is the ratio between the transmisison rate and recovery rate. When $\beta / \gamma > 1$, more people are becoming infected than are recovering, hence the system is in a state of outbreak. And, supposing that there is some percentage of the population that is already vaccinated (i.e., already in the recovered group), this ratio becomes $(\beta \times S(0))/(\gamma \times N)$, where $S(0)$ is the number of people in the susceptible group at time $t=0$.

These facts make it easy to define different transmission, recovery, and vaccination target rates to avoid a significant outbreak. Hence, the SIR is a simple model, but very effective at clearly communicating actionable results to policy makers and authority figures.

# Method

Using Epiverse-TRACE, RECONhub, and Epiforecasts suites of tools, and the R programming language [@dplyr2025manipulation; @purrr2025functional; @purrr2025functional; @tidyr2025tidy; @readr2024rectangular; @ggplot22016elegant; @epiparameter2025classes; @epidemics2025composable; @finalsize2025calculate; @cdcfluview2022retrieve; @socialmixr2025social].

```{r}
# renv::install("cleanepi")
# renv::install("epiparameter")
# renv::install("cfr")
# renv::install("epichains")
# renv::install("epidemics", repos = 'https://epiverse-trace.r-universe.dev')
# renv::install("vaccineff")
# renv::install("socialmixr")
# renv::install("finalsize")
# renv::install("hrbrmstr/cdcfluview")
# renv::install("outbreaks")
# renv::install("dplyr")
# renv::install("tidyr")
# renv::install("ggplot2")
# renv::status()
# renv::snapshot()
library(dplyr)
library(tidyr)
library(purrr)
library(readr)
library(ggplot2)
library(epiparameter)
library(epidemics)
library(cdcfluview)
library(socialmixr)
library(finalsize)
```

## Read & Describe Case Data

USA contact data [@breen2022novel].

```{r}
usa_files <- list.files(path = "data/predictions", pattern = ".rds$", full.names = TRUE) 
usa_data <- map(usa_files, read_rds, .progress = TRUE) 
usa_contacts <- bind_rows(map(usa_data, \(x) {x[[2]]}, .progress = TRUE))
usa_params <- bind_rows(map(usa_data, \(x) {x[[1]]}, .progress = TRUE))
```

Build contact matrix.

```{r}
readRDS("data/intermediatasdfsafdsae/")
usa_demography <- ungroup(usa_contacts) |>
  reframe(population = n(), .by = ".ego_age") |>
  mutate(proportion = population / sum(population))
usa_matrix <- prop.table(with(usa_contacts, table(.ego_age, .alter_age)))

contact_data <- contact_matrix(
  survey = polymod,
  countries = "United Kingdom",
  age.limits = c(0, 20, 40),
  symmetric = TRUE
)
contact_matrix <- t(contact_data$matrix)
demography <- contact_data$demography$population
names(demography) <- rownames(contact_matrix)
```

Define initial conditions.

```{r}
initial_i <- 1e-6
initial_conditions <- c(
  S = 1 - initial_i, E = 0, I = initial_i, R = 0, V = 0
)
initial_conditions <- rbind(
  initial_conditions,
  initial_conditions,
  initial_conditions
)
rownames(initial_conditions) <- rownames(contact_matrix)
```

Estimte population data/demographics.

```{r}
population_data <- population(
  name = "UK",
  contact_matrix = contact_matrix,
  demography_vector = demography,
  initial_conditions = initial_conditions
)
```

Define intervention measures.

```{r}
close_schools <- intervention(
  type = "contacts",
  time_begin = 200, # Days
  time_end = 260, # Also days
  reduction = matrix(c(0.5, 0.01, 0.01))
)
```

Estimate paramters.

```{r}
# Get a table of all available parameters
flu_params <- parameter_tbl(
  multi = epiparameter_db(), 
  disease = "Influenza"
)
# Get most recent parameters for other investigation
incubation_period <- epiparameter_db(
  disease = "Influenza",
  epi_name = "incubation_period",
  author = "Virlogeux",
  subset = sample_size > 250, 
  single_epiparameter = TRUE
)
serial_interval <- epiparameter_db(
  disease = "Influenza",
  epi_name = "serial_interval",
  single_epiparameter = TRUE
)
generation_time <- epiparameter_db(
  disease = "Influenza",
  epi_name = "generation_time",
  single_epiparameter = TRUE
)
```

```{r}
flu_ilinet <- ilinet(region = "national")
str(flu_ilinet)
lm(log(ilitotal) ~ week, data = filter(flu_ilinet, week < 8))
mutate(flu_ilinet, delta = c(0, diff(ilitotal))) |>
  filter(delta > 0) |>
  ggplot() +
  geom_density(mapping = aes(x = delta, fill = year, group = year), alpha = 0.5) +
  scale_fill_viridis_c()
```

```{r}
infectious_period <- 7 # days
incubation_period <- incubation_period$summary_stats$mean # days

R_0 <- 1.5 # Reproduction ratio
beta <- R_0 / infectious_period # Transmission rate
alpha <- 1 / incubation_period # Infection rate
gamma <- 1 / infectious_period # Recovery rate
```

Simulate epidemic

```{r}
base_output <- model_default(
  population = population_data,
  transmission_rate = beta,
  infectiousness_rate = alpha,
  recovery_rate = gamma,
  time_end = 600, # Days 
  increment = 1.0 # Also days
)
intervention_output <- model_default(
  population = population_data,
  transmission_rate = beta,
  infectiousness_rate = alpha,
  recovery_rate = gamma,
  intervention = list(contacts = close_schools),
  time_end = 600, # Days 
  increment = 1.0 # Also days
)
```

Analyze results.

```{r}
vis_infection <- function(x) {
  plt <- ggplot(data = x) +
    geom_point(mapping = aes(x = time, y = value, color = compartment)) +
    facet_wrap(
      vars(demography_group), 
      ncol = 1,
      labeller = labeller(demography_group = \(x) paste("Age range:", x))
    ) +
    theme_minimal() +
    scale_color_viridis_d() +
    labs(
      title = "Base Infection Behavior",
      x = "Time (days)", y = "Infected Individuals",
      color = "Infection State"
    )
  return(plt)
}
vis_infection(base_output)
vis_infection(intervention_output)
```

# Discussion

## Future Work

-   Underexplored covariates or regions.

-   Need for interdisciplinary models combining epidemiology, climatology, and public health.

-   Potential of machine learning to enhance traditional SIR frameworks.

## Conclusions

-   Summary of key findings.

-   Implications for pandemic preparedness and policy.

-   Call for more nuanced, data-rich modeling approaches.

# Old Work
The metapopulation stochastic model relies on both partitioning the population into sub-groups, and also randomness to model the spread of infectious diseases. @apolloni2014metapopulation describes this approach in great detail.

Effectively, there are two layers to this mode. First, there is a social layer, which follows the SIR paradigm to a degree. Second, there is a spatial layer, which models the distribution of individuals in space as well as their mobility.

For the social layer, we partition the population into two groups, $N_1=N\cdot\alpha$ and $N_2=N\cdot(1-\alpha)$, where $N$ is the population and $\alpha$ is the proportion of individuals in the first group.

These groups interact, and we use a two-by-two contact matrix to define these interaction rates.

$$
C = \begin{pmatrix}
\frac{p_1 q_1}{\alpha} & \frac{(1 - p_2) q_2}{\alpha} \\
\frac{(1 - p_1) q_1}{\alpha} & \frac{p_2 q_2}{1 - \alpha}
\end{pmatrix}
$$

Where $q_*$ is the contact rate of the group, and $p_*$ is the contact rate within a group.

We use another two-by-two matrix to describe the secondary infections. Effectively, this next-generation matrix is a function of the contact matrix because each new case is produced by exposures from preceding contacts.

$$
R = \frac{\beta}{\mu} \begin{pmatrix}
C_{11}\cdot\alpha & C_{12}\cdot\alpha \\
C_{21}\cdot(1-\alpha) & C_{22}\cdot(1-\alpha)
\end{pmatrix}
$$

-   Strengths and limitations in modeling flu pandemics.

-   Case studies using SIR models for H1N1, SARS, or seasonal influenza.

-   Use of stochastic vs. deterministic approaches.

# References